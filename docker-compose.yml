# The root orchestrator that unites the three divine realms
# Each service maintains its own docker-compose.yml for sacred isolation

include:
  - traefik/docker-compose.yml
  - auth/docker-compose.yml
  - mcp-echo/docker-compose.yml
  - mcp-fetch/docker-compose.yml
  - mcp-filesystem/docker-compose.yml
  - mcp-fetchs/docker-compose.yml
  - mcp-everything/docker-compose.yml
  - mcp-memory/docker-compose.yml
  - mcp-sequentialthinking/docker-compose.yml
  - mcp-time/docker-compose.yml
  - mcp-tmux/docker-compose.yml
  - mcp-playwright/docker-compose.yml

# Shared middleware definitions accessible to all services
services:
  # This is a dummy service that only defines shared middlewares
  # It uses the smallest possible image and exits immediately
  shared-middlewares:
    image: busybox:latest
    container_name: shared-middlewares
    command: ["true"]  # Exit immediately with success
    restart: "no"
    labels:
      - "traefik.enable=false"  # Don't route to this service
      
      # Shared ForwardAuth middleware for MCP services
      - "traefik.http.middlewares.mcp-auth.forwardauth.address=http://auth:8000/verify"
      - "traefik.http.middlewares.mcp-auth.forwardauth.authResponseHeaders=X-User-Id,X-User-Name,X-Auth-Token"
      
      # Shared CORS middleware for MCP services
      - "traefik.http.middlewares.mcp-cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE,PATCH"
      - "traefik.http.middlewares.mcp-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.mcp-cors.headers.accesscontrolalloworiginlist=https://claude.ai,https://console.anthropic.com"
      - "traefik.http.middlewares.mcp-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.mcp-cors.headers.addvaryheader=true"
      - "traefik.http.middlewares.mcp-cors.headers.accesscontrolallowcredentials=true"
      
      # Shared HTTPS redirect middleware
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

networks:
  public:
    external: true

volumes:
  traefik-certificates:
    external: true
  redis-data:
    external: true
  coverage-data:
    external: true
  auth-keys:
    external: true
  mcp-memory-data:
    external: true