# Configuration Reference

Complete reference for all configuration options in the MCP OAuth Gateway.

## Environment Variables

### Core Configuration

#### `BASE_DOMAIN`
**Type**: String  
**Required**: Yes  
**Description**: Base domain for all services (e.g., `example.com`)  
**Example**: `BASE_DOMAIN=mycompany.com`  
**Used by**: All services for hostname generation

#### `GATEWAY_JWT_SECRET`
**Type**: String (Base64URL-encoded)  
**Required**: Yes  
**Description**: Secret key for JWT token signing and validation  
**Generated by**: `just generate-jwt-secret`  
**Length**: 32 bytes (URL-safe base64 encoded)

### GitHub OAuth Configuration

#### `GITHUB_CLIENT_ID`
**Type**: String  
**Required**: Yes  
**Description**: GitHub OAuth application client ID  
**Example**: `GITHUB_CLIENT_ID=Iv1.a1b2c3d4e5f6g7h8`

#### `GITHUB_CLIENT_SECRET`
**Type**: String  
**Required**: Yes  
**Description**: GitHub OAuth application client secret  
**Example**: `GITHUB_CLIENT_SECRET=1234567890abcdef...`

#### `ALLOWED_GITHUB_USERS`
**Type**: Comma-separated string  
**Required**: Yes  
**Description**: GitHub usernames allowed to authenticate  
**Example**: `ALLOWED_GITHUB_USERS=user1,user2,user3`

### OAuth Gateway Tokens

#### `GATEWAY_OAUTH_ACCESS_TOKEN`
**Type**: JWT string  
**Required**: For testing  
**Description**: Pre-generated access token for gateway operations  
**Generated by**: `just generate-github-token`

#### `GATEWAY_OAUTH_REFRESH_TOKEN`
**Type**: String  
**Required**: For testing  
**Description**: Refresh token for automatic token renewal  
**Generated by**: `just generate-github-token`

### MCP Client Configuration

#### `MCP_CLIENT_ACCESS_TOKEN`
**Type**: JWT string  
**Required**: For external clients  
**Description**: Access token for MCP client applications  
**Generated by**: `just mcp-client-token`

#### `MCP_PROTOCOL_VERSION`
**Type**: String  
**Default**: `2025-06-18`  
**Description**: MCP protocol version to use  
**Example**: `MCP_PROTOCOL_VERSION=${MCP_PROTOCOL_VERSION:-2025-06-18}`

### Service Configuration

#### `CLIENT_LIFETIME`
**Type**: Integer (seconds)  
**Default**: `7776000` (90 days)  
**Special**: Set to `0` for eternal clients  
**Description**: OAuth client registration lifetime

## Docker Configuration

### Network Settings

All services use the `public` external network:

```yaml
networks:
  public:
    external: true
```

### Volume Mounts

#### Persistent Volumes
- `traefik-certificates`: SSL certificates storage
- `redis-data`: Redis persistence
- `auth-keys`: JWT signing keys
- `mcp-memory-data`: Memory service data

#### Bind Mounts
- `./logs:/app/logs`: Centralized logging
- `./.env:/app/.env`: Environment configuration

### Service Ports

#### Internal Ports (Docker network)
- **Auth Service**: `8000`
- **Redis**: `6379`
- **MCP Services**: `3000`
- **Traefik Dashboard**: `8080`

#### External Ports (Host)
- **HTTP**: `80` → Traefik
- **HTTPS**: `443` → Traefik
- **Traefik Dashboard**: `8080` (optional)

## Service-Specific Configuration

### Traefik Configuration

#### Labels for OAuth Routes
```yaml
- "traefik.http.routers.auth-oauth.rule=PathPrefix(`/register`) || PathPrefix(`/authorize`) || PathPrefix(`/token`) || PathPrefix(`/callback`) || PathPrefix(`/.well-known`)"
- "traefik.http.routers.auth-oauth.priority=4"
```

#### Labels for MCP Routes
```yaml
- "traefik.http.routers.mcp-fetch.rule=Host(`mcp-fetch.${BASE_DOMAIN}`)"
- "traefik.http.routers.mcp-fetch.middlewares=mcp-auth"
- "traefik.http.routers.mcp-fetch.priority=2"
```

#### ForwardAuth Middleware
```yaml
- "traefik.http.middlewares.mcp-auth.forwardauth.address=http://auth:8000/verify"
- "traefik.http.middlewares.mcp-auth.forwardauth.authResponseHeaders=X-User-Id,X-User-Name,X-Auth-Token"
```

### Redis Configuration

#### Key Patterns
```
oauth:state:{state}          # OAuth state parameters
oauth:code:{code}            # Authorization codes  
oauth:token:{jti}            # Access tokens
oauth:refresh:{token}        # Refresh tokens
oauth:client:{client_id}     # Client registrations
oauth:user_tokens:{user}     # User token index
```

#### TTL Settings
- **OAuth States**: 300 seconds (5 minutes)
- **Authorization Codes**: 600 seconds (10 minutes)
- **Access Tokens**: 1800 seconds (30 minutes)
- **Refresh Tokens**: 31536000 seconds (1 year)

### MCP Service Configuration

#### mcp-streamablehttp-proxy Settings
```yaml
environment:
  - PORT=3000
  - MCP_COMMAND=python -m mcp_server_time
  - MCP_PROTOCOL_VERSION=${MCP_PROTOCOL_VERSION:-2025-06-18}
```

#### Health Check Configuration
```yaml
# For Auth Service - using OAuth discovery endpoint
healthcheck:
  test: ["CMD", "curl", "-f", "-s", "http://localhost:8000/.well-known/oauth-authorization-server"]
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 30s

# For MCP Services - using protocol initialization
healthcheck:
  test: ["CMD", "sh", "-c", "curl -s -X POST http://localhost:3000/mcp -H 'Content-Type: application/json' -H 'Accept: application/json, text/event-stream' -d '{\"jsonrpc\":\"2.0\",\"method\":\"initialize\",\"params\":{\"protocolVersion\":\"'$$MCP_PROTOCOL_VERSION'\",\"capabilities\":{},\"clientInfo\":{\"name\":\"healthcheck\",\"version\":\"1.0\"}},\"id\":1}' | grep -q '\"protocolVersion\":\"'$$MCP_PROTOCOL_VERSION'\"'"]
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 40s
```

## Security Configuration

### JWT Configuration

#### Algorithm
- **Signing**: RS256 (RSA with SHA-256)
- **Key Length**: 2048 bits minimum
- **Token Lifetime**: 30 minutes (access), 1 year (refresh)

#### Claims Structure
```json
{
  "iss": "mcp-oauth-gateway",
  "sub": "github_user_id", 
  "aud": "mcp-services",
  "exp": 1735689600,
  "iat": 1735688000,
  "jti": "unique_token_id",
  "client_id": "registered_client_id",
  "scope": "mcp.fetch mcp.memory mcp.time",
  "github_user": "username",
  "github_id": 12345678
}
```

### CORS Configuration

#### Allowed Origins
- Same-origin requests
- Configured redirect URIs
- Claude.ai domains (if applicable)

#### Allowed Headers
```
Authorization
Content-Type
MCP-Protocol-Version
Mcp-Session-Id
```

### SSL/TLS Configuration

#### Let's Encrypt ACME
```yaml
certificatesResolvers:
  letsencrypt:
    acme:
      email: ${ACME_EMAIL}
      storage: /certificates/acme.json
      httpChallenge:
        entryPoint: web
```

#### TLS Settings
- **Minimum Version**: TLS 1.2
- **Preferred Version**: TLS 1.3
- **Cipher Suites**: Modern secure ciphers only

## Configuration Validation

### Startup Checks

Services validate configuration at startup:

1. **Required Environment Variables**: All required vars present
2. **Token Validity**: JWT secrets and GitHub tokens valid
3. **Network Connectivity**: Services can reach dependencies
4. **Storage Access**: Redis and volume access verified

### Health Check Endpoints

#### Auth Service: `/.well-known/oauth-authorization-server`
The OAuth discovery endpoint serves as the health check. A successful response indicates the service is operational:
```json
{
  "issuer": "https://auth.yourdomain.com",
  "authorization_endpoint": "https://auth.yourdomain.com/authorize",
  "token_endpoint": "https://auth.yourdomain.com/token",
  "registration_endpoint": "https://auth.yourdomain.com/register"
}
```

#### MCP Services: Protocol Initialization
MCP services are verified via the MCP protocol initialization handshake. A successful initialization response indicates the service is operational:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "protocolVersion": "2025-06-18",
    "capabilities": {...},
    "serverInfo": {...}
  },
  "id": 1
}
```

## Configuration Files

### Docker Compose Files

#### Main Configuration: `docker-compose.yml`
- Service definitions
- Network configuration  
- Volume mounts
- Basic environment

#### Coverage Testing: `docker-compose.coverage.yml`
- Coverage instrumentation
- Sidecar containers
- Modified health checks

#### Development Override: `docker-compose.override.yml` (optional)
- Local development settings
- Debug configurations
- Port mappings

### Environment Files

#### `.env` (Required)
- All production configuration
- Secrets and tokens
- Service-specific settings

#### `.env.example` (Template)
- Example configuration
- Documentation for variables
- Safe defaults where applicable

## Best Practices

### Security
- Rotate JWT secrets regularly
- Use strong, unique passwords
- Enable HTTPS everywhere
- Validate all inputs

### Performance
- Monitor Redis memory usage
- Set appropriate TTLs
- Use connection pooling
- Cache static content

### Monitoring
- Enable structured logging
- Monitor SSL certificate expiry
- Track OAuth token usage
- Set up health check alerts

### Backup
- Backup OAuth registrations
- Export Redis data regularly
- Store configuration securely
- Test restore procedures

[Configuration reference documentation - comprehensive settings and environment variables]