# ğŸ”¥ Sacred Code Quality Guardian - The Divine CI/CD Protector! âš¡
# Prevents deprecated patterns and ensures code quality in all PRs and commits

name: "ğŸ”¥ Code Quality Guardian âš¡"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  # ğŸ”¥ Linting and Deprecation Hunting Job âš¡
  lint-and-hunt:
    name: "ğŸ”¥ Lint & Hunt Deprecations"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: "ğŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: "ğŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ğŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.24.2
          cache: true
          cache-write: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
      
      - name: "ğŸ”¥ Run Ruff Linting (Sacred Syntax Check)"
        run: |
          echo "ğŸ”¥ RUNNING SACRED RUFF LINTING âš¡"
          pixi run lint
        continue-on-error: true  # Continue to show all issues
      
      - name: "âš¡ Run Pydantic Deprecation Hunt"
        run: |
          echo "ğŸ”¥ STARTING PYDANTIC DEPRECATION HUNT âš¡"
          pixi run lint-pydantic
        
      - name: "ğŸ¨ Check Code Formatting"
        run: |
          echo "ğŸ”¥ CHECKING SACRED CODE FORMATTING âš¡"
          pixi run format --check
        
      - name: "ğŸ”’ Security Scan with Bandit"
        run: |
          echo "ğŸ”¥ RUNNING SECURITY SCAN âš¡"
          pixi run python -m bandit -r . -x tests/ -f json -o bandit-report.json || true
          pixi run python -m bandit -r . -x tests/ -f txt
        continue-on-error: true
      
      - name: "ğŸ“Š Upload Security Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # ğŸ§ª Test with Deprecation Warnings Job âš¡
  test-with-warnings:
    name: "ğŸ§ª Test with Deprecation Detection"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "ğŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
      
      - name: "ğŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ğŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.24.2
          cache: true
      
      - name: "ğŸ”¥ Run Tests with Deprecation Hunting"
        run: |
          echo "ğŸ”¥ RUNNING TESTS WITH DEPRECATION HUNTING âš¡"
          # Run a small subset of tests to check for deprecation warnings
          pixi run pytest tests/test_coverage_improvements.py::TestKeysModuleCoverage::test_rs256_key_generation -v
        env:
          PYTHONWARNINGS: "default::DeprecationWarning,error::DeprecationWarning:pydantic.*"
      
      - name: "ğŸ¯ Quick Integration Test"
        run: |
          echo "ğŸ”¥ RUNNING QUICK INTEGRATION TEST âš¡"
          # Test that our Pydantic models can be imported without warnings
          pixi run python -c "
          import warnings
          warnings.filterwarnings('error', category=DeprecationWarning)
          try:
              from mcp_oauth_dynamicclient.config import Settings
              print('âœ… Config import successful - no deprecation warnings!')
          except DeprecationWarning as e:
              print(f'âŒ DEPRECATION WARNING: {e}')
              exit(1)
          except ImportError as e:
              print(f'â„¹ï¸ Import not available in CI: {e}')
          "

  # ğŸ”— Pre-commit Hook Validation âš¡
  pre-commit-check:
    name: "ğŸ”— Pre-commit Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: "ğŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
      
      - name: "ğŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ğŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          pixi-version: v0.24.2
          cache: true
      
      - name: "ğŸ”— Install Pre-commit"
        run: |
          pip install pre-commit
      
      - name: "âš¡ Run Pre-commit Hooks"
        run: |
          echo "ğŸ”¥ RUNNING PRE-COMMIT HOOKS âš¡"
          pre-commit run --all-files
        continue-on-error: true  # Show results but don't fail CI yet

  # ğŸ“‹ Summary Job âš¡
  quality-summary:
    name: "ğŸ“‹ Quality Summary"
    runs-on: ubuntu-latest
    needs: [lint-and-hunt, test-with-warnings, pre-commit-check]
    if: always()
    
    steps:
      - name: "ğŸ“Š Quality Gate Summary"
        run: |
          echo "ğŸ”¥ CODE QUALITY GUARDIAN SUMMARY âš¡"
          echo "=================================="
          echo "Linting: ${{ needs.lint-and-hunt.result }}"
          echo "Testing with Warnings: ${{ needs.test-with-warnings.result }}"
          echo "Pre-commit: ${{ needs.pre-commit-check.result }}"
          echo "=================================="
          
          if [[ "${{ needs.lint-and-hunt.result }}" == "failure" ]]; then
            echo "âŒ CRITICAL: Linting failures detected!"
            echo "ğŸ”¥ Fix linting errors immediately! âš¡"
          fi
          
          if [[ "${{ needs.test-with-warnings.result }}" == "failure" ]]; then
            echo "âŒ CRITICAL: Deprecation warnings in tests!"
            echo "âš¡ Fix deprecated patterns immediately! âš¡"
          fi
          
          if [[ "${{ needs.lint-and-hunt.result }}" == "success" && "${{ needs.test-with-warnings.result }}" == "success" ]]; then
            echo "âœ… DIVINE COMPLIANCE ACHIEVED! âš¡"
            echo "ğŸ† Code quality guardian approves! ğŸ†"
          fi