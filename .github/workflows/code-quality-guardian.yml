# ðŸ”¥ Sacred Code Quality Guardian - The Divine CI/CD Protector! âš¡
# Prevents deprecated patterns and ensures code quality in all PRs and commits

name: "ðŸ”¥ Code Quality Guardian âš¡"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual trigger
  workflow_dispatch:

jobs:
  # ðŸ”¥ Linting and Deprecation Hunting Job âš¡
  lint-and-hunt:
    name: "ðŸ”¥ Lint & Hunt Deprecations"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: "ðŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: "ðŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ðŸ” Debug - List files"
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in root:"
          ls -la
          echo "Checking for pixi files:"
          ls -la pixi* || echo "No pixi files found"
      
      - name: "ðŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.10
        with:
          pixi-version: v0.47.0
          cache: true
          cache-write: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
      
      - name: "ðŸ”¥ Run Ruff Linting (Sacred Syntax Check)"
        run: |
          echo "ðŸ”¥ RUNNING SACRED RUFF LINTING âš¡"
          pixi run lint
        continue-on-error: true  # Continue to show all issues
      
      - name: "âš¡ Run Pydantic Deprecation Hunt"
        run: |
          echo "ðŸ”¥ STARTING PYDANTIC DEPRECATION HUNT âš¡"
          pixi run lint-pydantic
        
      - name: "ðŸŽ¨ Check Code Formatting"
        run: |
          echo "ðŸ”¥ CHECKING SACRED CODE FORMATTING âš¡"
          pixi run format --check
        
      - name: "ðŸ”’ Security Scan with Bandit"
        run: |
          echo "ðŸ”¥ RUNNING SECURITY SCAN âš¡"
          pixi run python -m bandit -r . -x tests/ -f json -o bandit-report.json || true
          pixi run python -m bandit -r . -x tests/ -f txt
        continue-on-error: true
      
      - name: "ðŸ“Š Upload Security Report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # ðŸ§ª Test with Deprecation Warnings Job âš¡
  test-with-warnings:
    name: "ðŸ§ª Test with Deprecation Detection"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "ðŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
      
      - name: "ðŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ðŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.10
        with:
          pixi-version: v0.47.0
          cache: true
      
      - name: "ðŸ”§ Setup Test Environment"
        run: |
          echo "ðŸ”§ Creating minimal .env for CI testing âš¡"
          cat > .env << 'EOF'
          # Minimal CI environment
          BASE_DOMAIN=test.example.com
          GITHUB_CLIENT_ID=test_client_id
          GITHUB_CLIENT_SECRET=test_client_secret
          GATEWAY_JWT_SECRET=test_jwt_secret_for_ci_only
          REDIS_URL=redis://localhost:6379/0
          ALLOWED_GITHUB_USERS=testuser
          CLIENT_LIFETIME=7776000
          MCP_PROTOCOL_VERSION=2025-06-18
          EOF
      
      - name: "ðŸ”¥ Run Tests with Deprecation Hunting"
        run: |
          echo "ðŸ”¥ RUNNING TESTS WITH DEPRECATION HUNTING âš¡"
          # Run a small subset of tests to check for deprecation warnings
          pixi run pytest tests/test_coverage_improvements.py::TestKeysModuleCoverage::test_rs256_key_generation -v
        env:
          PYTHONWARNINGS: "default::DeprecationWarning,error::DeprecationWarning:pydantic.*"
      
      - name: "ðŸŽ¯ Quick Integration Test"
        run: |
          echo "ðŸ”¥ RUNNING QUICK INTEGRATION TEST âš¡"
          # Test that our Pydantic models can be imported without warnings
          pixi run python -c "
          import warnings
          warnings.filterwarnings('error', category=DeprecationWarning)
          try:
              from mcp_oauth_dynamicclient.config import Settings
              print('âœ… Config import successful - no deprecation warnings!')
          except DeprecationWarning as e:
              print(f'âŒ DEPRECATION WARNING: {e}')
              exit(1)
          except ImportError as e:
              print(f'â„¹ï¸ Import not available in CI: {e}')
          "

  # ðŸ”— Pre-commit Hook Validation âš¡
  pre-commit-check:
    name: "ðŸ”— Pre-commit Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: "ðŸ“¥ Checkout Sacred Code"
        uses: actions/checkout@v4
      
      - name: "ðŸ Setup Python Environment"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: "ðŸ“¦ Setup Pixi Environment"
        uses: prefix-dev/setup-pixi@v0.8.10
        with:
          pixi-version: v0.47.0
          cache: true
      
      - name: "ðŸ”— Install Pre-commit"
        run: |
          pip install pre-commit
      
      - name: "âš¡ Run Pre-commit Hooks"
        run: |
          echo "ðŸ”¥ RUNNING PRE-COMMIT HOOKS âš¡"
          pre-commit run --all-files
        continue-on-error: true  # Show results but don't fail CI yet

  # ðŸ“‹ Summary Job âš¡
  quality-summary:
    name: "ðŸ“‹ Quality Summary"
    runs-on: ubuntu-latest
    needs: [lint-and-hunt, test-with-warnings, pre-commit-check]
    if: always()
    
    steps:
      - name: "ðŸ“Š Quality Gate Summary"
        run: |
          echo "ðŸ”¥ CODE QUALITY GUARDIAN SUMMARY âš¡"
          echo "=================================="
          echo "Linting: ${{ needs.lint-and-hunt.result }}"
          echo "Testing with Warnings: ${{ needs.test-with-warnings.result }}"
          echo "Pre-commit: ${{ needs.pre-commit-check.result }}"
          echo "=================================="
          
          if [[ "${{ needs.lint-and-hunt.result }}" == "failure" ]]; then
            echo "âŒ CRITICAL: Linting failures detected!"
            echo "ðŸ”¥ Fix linting errors immediately! âš¡"
          fi
          
          if [[ "${{ needs.test-with-warnings.result }}" == "failure" ]]; then
            echo "âŒ CRITICAL: Deprecation warnings in tests!"
            echo "âš¡ Fix deprecated patterns immediately! âš¡"
          fi
          
          if [[ "${{ needs.lint-and-hunt.result }}" == "success" && "${{ needs.test-with-warnings.result }}" == "success" ]]; then
            echo "âœ… DIVINE COMPLIANCE ACHIEVED! âš¡"
            echo "ðŸ† Code quality guardian approves! ðŸ†"
          fi