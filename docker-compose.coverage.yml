# Sacred Coverage Overlay - Production coverage without contamination!
# This overlay adds coverage tracking to production containers

services:
  auth:
    # Override to use the original dockerfile and run with PYTHONPATH
    command: |
      bash -c "
        export PYTHONPATH=/src:$PYTHONPATH &&
        python -m coverage run --source=/src -m mcp_oauth_dynamicclient.server --host 0.0.0.0 --port 8000
      "
    # Run as root for coverage data writing
    user: root
    environment:
      # Include all the required environment variables from base compose
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - JWT_SECRET=${GATEWAY_JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - JWT_PRIVATE_KEY_B64=${JWT_PRIVATE_KEY_B64}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - ACCESS_TOKEN_LIFETIME=${ACCESS_TOKEN_LIFETIME}
      - REFRESH_TOKEN_LIFETIME=${REFRESH_TOKEN_LIFETIME}
      - SESSION_TIMEOUT=${SESSION_TIMEOUT}
      - CLIENT_LIFETIME=${CLIENT_LIFETIME}
      - ALLOWED_GITHUB_USERS=${ALLOWED_GITHUB_USERS}
      - MCP_PROTOCOL_VERSION=${MCP_PROTOCOL_VERSION}
      - MCP_CORS_ORIGINS=${MCP_CORS_ORIGINS}
      # Coverage environment
      - COVERAGE_FILE=/coverage-data/.coverage
      - PYTHONPATH=/src:${PYTHONPATH:-}
    volumes:
      # Mount source code directly
      - ./mcp-oauth-dynamicclient/src:/src:ro
      - coverage-data:/coverage-data:rw
      # Mount .coveragerc
      - ./coverage-spy/.coveragerc:/app/.coveragerc:ro
    # Ensure graceful shutdown for coverage collection
    stop_grace_period: 10s

  # Coverage harvester - collects and combines coverage data
  coverage-harvester:
    image: python:3.11-slim
    container_name: coverage-harvester
    networks:
      - public
    volumes:
      - ./mcp-oauth-dynamicclient/src:/src:ro
      - coverage-data:/coverage-data:rw
      - ./htmlcov:/htmlcov:rw
      - ./coverage-spy/.coveragerc:/.coveragerc:ro
      - ./scripts:/scripts:ro
      - .:/workspace:ro  # For proper path mapping
    working_dir: /workspace
    environment:
      - COVERAGE_FILE=/coverage-data/.coverage
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        pip install coverage
        echo 'Coverage harvester started'
        
        # Wait for coverage data to be written
        python /scripts/wait_for_coverage.py
        
        # Copy coverage data and process
        cd /workspace
        if [ -f /coverage-data/.coverage ]; then
            cp /coverage-data/.coverage .coverage
            
            # Fix paths in database
            pixi run python -m coverage combine || true
            
            # Generate report with proper paths
            pixi run python -m coverage report --include="mcp-oauth-dynamicclient/src/*" || true
            
            # Generate HTML report
            pixi run python -m coverage html --include="mcp-oauth-dynamicclient/src/*" -d htmlcov || true
            
            echo "✅ Coverage report generated"
        else
            echo "❌ No coverage data found"
        fi
        
        echo 'Coverage harvester completed'
        # Keep container alive briefly to allow log collection
        sleep 5
    depends_on:
      - auth

volumes:
  coverage-data:
    external: true

networks:
  public:
    external: true